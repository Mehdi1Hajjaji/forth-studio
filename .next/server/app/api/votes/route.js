"use strict";(()=>{var e={};e.id=494,e.ids=[494],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},86955:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>j,requestAsyncStorage:()=>I,routeModule:()=>y,serverHooks:()=>q,staticGenerationAsyncStorage:()=>x});var i={};r.r(i),r.d(i,{GET:()=>f,POST:()=>v});var s=r(49303),n=r(88716),o=r(60670),a=r(53524),u=r(87070),l=r(13538),d=r(95456),p=r(1184),c=r(96263);function m(e,t=400,r){return u.NextResponse.json({error:e,details:r},{status:t})}async function f(e){let{searchParams:t}=new URL(e.url),r=t.get("storyId"),i=t.get("projectId"),s=t.get("submissionId"),n=t.get("userId");if(1!==[r,i,s].filter(Boolean).length)return m("Specify exactly one target to retrieve votes.");let o=w({storyId:r??void 0,projectId:i??void 0,submissionId:s??void 0}),[a,d]=await Promise.all([g(o),n?l.Z.vote.findFirst({where:{userId:n,...o}}):Promise.resolve(null)]);return u.NextResponse.json({data:{totals:a,userVote:d?d.value:null}})}async function v(e){let t;try{let r=await e.json();t=(0,p.VO)(r)}catch(e){if(e instanceof c.jmq)return m("Invalid vote payload.",422,e.flatten());return m("Malformed JSON body.")}let r=await (0,d.ts)(),i=t.userId??r?.id??null;if(!i)return m("Authentication required.",401);if(t.userId&&r?.id&&t.userId!==r.id)return m("You cannot vote on behalf of another user.",403);let[s,n]=await Promise.all([l.Z.user.findUnique({where:{id:i}}),h(t)]);if(!s)return m("User not found.",404);if(!n)return m("Target resource not found.",404);let o=w(t);try{let e=await l.Z.vote.findFirst({where:{userId:i,...o}});if(0===t.value){e&&await l.Z.vote.delete({where:{id:e.id}});let t=await g(o);return u.NextResponse.json({data:null,meta:{totals:t}})}let r=e?await l.Z.vote.update({where:{id:e.id},data:{value:t.value}}):await l.Z.vote.create({data:{userId:i,value:t.value,storyId:t.storyId,projectId:t.projectId,submissionId:t.submissionId}}),s=await g(o);return u.NextResponse.json({data:{vote:r,totals:s}})}catch(e){if(e instanceof a.Prisma.PrismaClientKnownRequestError)return m(e.message,400);throw e}}function w({storyId:e,projectId:t,submissionId:r}){if(e)return{storyId:e};if(t)return{projectId:t};if(r)return{submissionId:r};throw Error("Missing vote target.")}async function g(e){let[t,r]=await Promise.all([l.Z.vote.count({where:{...e,value:{gt:0}}}),l.Z.vote.count({where:{...e,value:{lt:0}}})]);return{upvotes:t,downvotes:r,score:t-r}}async function h(e){return e.storyId?!!await l.Z.story.findUnique({where:{id:e.storyId}}):e.projectId?!!await l.Z.project.findUnique({where:{id:e.projectId}}):!!e.submissionId&&!!await l.Z.submission.findUnique({where:{id:e.submissionId}})}let y=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/votes/route",pathname:"/api/votes",filename:"route",bundlePath:"app/api/votes/route"},resolvedPagePath:"c:\\Users\\pc\\OneDrive\\Desktop\\forth.studio\\src\\app\\api\\votes\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:I,staticGenerationAsyncStorage:x,serverHooks:q}=y,b="/api/votes/route";function j(){return(0,o.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:x})}},95456:(e,t,r)=>{r.d(t,{Lz:()=>u,ts:()=>d}),r(6113);var i=r(13539),s=r(53797),n=r(98691),o=r(75571),a=r(13538);let u={adapter:(0,i.N)(a.Z),session:{strategy:"database"},secret:function(){let e=process.env.NEXTAUTH_SECRET;if(!e)throw Error("NEXTAUTH_SECRET is required in production environments.");return e}(),pages:{signIn:"/auth/sign-in"},providers:[(0,s.Z)({name:"Email and password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e.password)return null;let t=await a.Z.user.findUnique({where:{email:e.email.toLowerCase()}});return t&&await (0,n.qu)(e.password,t.hashedPassword)?{id:t.id,email:t.email,name:t.name??t.username,image:t.avatarUrl??null}:null}})],callbacks:{async session({session:e,user:t}){if(!e.user)return e;let r=t??(e.user.email?await a.Z.user.findUnique({where:{email:e.user.email.toLowerCase()},select:{id:!0,name:!0,username:!0,email:!0,avatarUrl:!0}}):null);return r&&(e.user={...e.user,id:r.id}),e}}};async function l(){return(0,o.getServerSession)(u)}async function d(){let e=await l();return e?.user??null}},13538:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(53524);let s=globalThis.prisma??new i.PrismaClient({log:["error"]})},1184:(e,t,r)=>{r.d(t,{Kl:()=>l,VO:()=>p,Wi:()=>d});var i=r(96263);let s=()=>i.Z_8().cuid({message:"Invalid identifier"});function n(e,t){let r=[t.storyId?"storyId":null,t.projectId?"projectId":null,t.submissionId?"submissionId":null].filter(Boolean);0===r.length?e.addIssue({code:i.NLt.custom,message:"Specify exactly one target resource."}):r.length>1&&e.addIssue({code:i.NLt.custom,message:`Multiple targets provided (${r.join(", ")}). Select only one.`})}let o=i.Ryn({authorId:s().optional(),body:i.Z_8().trim().min(3,"Comment is too short.").max(2e3),storyId:s().optional(),projectId:s().optional(),submissionId:s().optional()}).superRefine((e,t)=>n(t,e)),a=i.Ryn({userId:s().optional(),problemSlug:i.Z_8().trim().min(1,"Problem slug is required."),language:i.Z_8().trim().min(1,"Language is required."),code:i.Z_8().min(10,"Code snippet is too short."),notes:i.Z_8().trim().max(4e3).optional(),makePublic:i.O72().optional()}),u=i.Ryn({userId:s().optional(),value:i.G0j([i.i0J(1),i.i0J(-1),i.i0J(0)]).default(1),storyId:s().optional(),projectId:s().optional(),submissionId:s().optional()}).superRefine((e,t)=>n(t,e));function l(e){return o.parse(e)}function d(e){return a.parse(e)}function p(e){return u.parse(e)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[948,972,24,263],()=>r(86955));module.exports=i})();